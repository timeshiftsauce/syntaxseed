import{d as k,b as w,T as g,a as y}from"./index-BGiSXJig.js";import{x as C,a7 as F}from"./index-C3V9u2Ed.js";import N from"./popupForm-CSKucZI3.js";import{g as S,b as T,a as B,c as A}from"./dataexport-C0G_-UsK.js";import{e as I,p as h,a0 as R,ad as p,H as E,z as v,m as q,h as L,o as x,N as P,T as G,l as u,s as d,at as O}from"./vue-DdIC1N8d.js";import"./index-B2cyAL5t.js";import"./index-1wj2obtz.js";import"./validate-BCdw8ftN.js";const D={class:"default-main ba-table-box"},W=I({name:"routine/dataexport",__name:"index",setup(H){const{t:i}=C.useI18n(),f=h(),_=h(),j=R();let c=[{render:"confirmButton",name:"test",title:"routine.dataexport.test",text:"",type:"primary",icon:"fa fa-wrench",class:"table-row-test",popconfirm:{confirmButtonText:i("Confirm"),cancelButtonText:i("Cancel"),confirmButtonType:"primary",width:"180px",title:"将导出前10条数据，请目检数据是否正常且完整"},disabledTip:!1,click:t=>{S(t.id).then(a=>{window.location.href=T(a.data.taskId)})}},{render:"confirmButton",name:"export",title:"routine.dataexport.export",text:"",type:"danger",icon:"fa fa-play-circle",class:"table-row-export",popconfirm:{confirmButtonText:i("Confirm"),cancelButtonText:i("Cancel"),confirmButtonType:"danger",width:"200px",title:"导出为高磁盘I/O操作，大数据导出任务请在闲时执行，确认开始导出任务吗？"},disabledTip:!1,click:t=>{B(t.id).then(a=>{a.data.download?window.location.href=T(a.data.id):j.push({name:"routine/dataexport/taskControl",params:{id:a.data.id}})})}}];c=c.concat(k(["edit","delete"]));const e=new w(new F("/admin/routine.dataexport/"),{pk:"id",column:[{type:"selection",align:"center",operator:!1},{label:i("routine.dataexport.id"),prop:"id",align:"center",width:70,sortable:"custom",operator:"RANGE"},{label:i("routine.dataexport.admin_id"),prop:"admin.nickname",operator:"LIKE",align:"center"},{label:i("routine.dataexport.name"),prop:"name",align:"center"},{label:i("routine.dataexport.main_table"),prop:"main_table",align:"center"},{label:i("routine.dataexport.lastprogress"),prop:"lastprogress",align:"center",operator:"RANGE"},{label:i("routine.dataexport.lastexporttime"),prop:"lastexporttime",align:"center",render:"datetime",sortable:"custom",operator:"RANGE",width:160},{label:i("routine.dataexport.lastfile"),prop:"lastfile",align:"center",operator:!1,render:"url"},{label:i("routine.dataexport.createtime"),prop:"createtime",align:"center",render:"datetime",sortable:"custom",operator:"RANGE",width:160},{label:i("Operate"),align:"center",width:160,render:"buttons",buttons:c,operator:!1}],dblClickNotEditColumn:[void 0],defaultOrder:{prop:"id",order:"desc"}},{defaultItems:{xls_max_number:"10000",concurrent_create_xls:"3",memory_limit:"128",lastprogress:"0",where:[],where_field:""}},{toggleForm:({operate:t})=>{t=="Add"&&(e.form.loading=!0,A().then(a=>{e.form.extend.tables=a.data.tables,e.form.loading=!1,e.form.items.joinTableNumber=0,e.form.items.joinTable=[],e.form.items.joinTableAsName=[],e.form.items.joinTableFields=[],e.form.items.joinTablePk=[],e.form.items.joinTableFk=[],e.form.items.joinTableType=[]}))},onSubmit:({formEl:t,operate:a,items:o})=>{const n=[];for(const r in o.fields)n.push(e.form.extend.fieldSelect[o.fields[r]]);const l=[];for(const r in o.joinTable){if(r==e.form.items.joinTableNumber)break;const m=[];for(const b in o.joinTableFields[r])m.push(p(e.form.extend.joinTableFieldSelect[r][o.joinTableFields[r][b]]));l[r]={table:o.joinTable[r],pk:o.joinTablePk[r],fk:o.joinTableFk[r],asname:o.joinTableAsName[r],fields:m,type:o.joinTableType[r]}}a=a.replace(a[0],a[0].toLowerCase());const s=()=>{e.form.submitLoading=!0,e.api.postData(a,{id:e.form.items.id,name:e.form.items.name,main_table:e.form.items.main_table,field_config:n,join_table:l,where_field:p(e.form.items.where),order_field:p(e.form.items.order),xls_max_number:e.form.items.xls_max_number,concurrent_create_xls:e.form.items.concurrent_create_xls,memory_limit:e.form.items.memory_limit,export_number:e.form.items.export_number}).then(r=>{var m;e.onTableHeaderAction("refresh",{}),e.form.submitLoading=!1,(m=e.form.operateIds)==null||m.shift(),e.form.operateIds.length>0?e.toggleForm("Edit",e.form.operateIds):e.toggleForm(),e.runAfter("onSubmit",{res:r})}).catch(()=>{e.form.submitLoading=!1})};return t?(e.form.ref=t,t.validate((r,m)=>{if(r)s();else for(const b in m)E({message:m[b][0].message,type:"error"})})):s(),!1}},{requestEdit:({res:t})=>{e.form.extend.tables=t.data.tables,e.form.extend.onTableChangeCallback=()=>{const o=[];for(const n in t.data.row.field_config){o.push(t.data.row.field_config[n].name);for(const l in e.form.extend.fieldSelect)e.form.extend.fieldSelect[l].name==t.data.row.field_config[n].name&&(e.form.extend.fieldSelect[l]=t.data.row.field_config[n])}e.form.items.fields=o},f.value.onTableChange(t.data.row.main_table),e.form.items.joinTableNumber=t.data.row.join_table.length,e.form.items.joinTable=[],e.form.items.joinTableAsName=[],e.form.items.joinTableFields=[],e.form.items.joinTablePk=[],e.form.items.joinTableFk=[],e.form.items.joinTableType=[],e.form.items.onJoinTableChangeCallback=[];for(const o in t.data.row.join_table)e.form.items.joinTable.push(t.data.row.join_table[o].table),e.form.items.joinTableAsName.push(t.data.row.join_table[o].asname),e.form.items.joinTablePk.push(t.data.row.join_table[o].pk),e.form.items.joinTableFk.push(t.data.row.join_table[o].fk),e.form.items.joinTableType.push(t.data.row.join_table[o].type),f.value.onJoinTableChange(t.data.row.join_table[o].table,o),e.form.items.onJoinTableChangeCallback[o]=()=>{const n=[];for(const l in t.data.row.join_table[o].fields){n.push(t.data.row.join_table[o].fields[l].name);for(const s in e.form.extend.joinTableFieldSelect[o])e.form.extend.joinTableFieldSelect[o][s].name==t.data.row.join_table[o].fields[l].name&&(e.form.extend.joinTableFieldSelect[o][s]=t.data.row.join_table[o].fields[l])}e.form.items.joinTableFields[o]=n};e.form.items.where=t.data.row.where_field,e.form.items.order=t.data.row.order_field;const a=[];for(const o in e.form.items.order)a.push(e.form.items.order[o].field);e.form.items.order_field=a,e.form.items.where_field=""}});return O("baTable",e),v(()=>{var t;e.table.ref=_.value,e.mount(),(t=e.getIndex())==null||t.then(()=>{e.initSort(),e.dragSort()})}),(t,a)=>{const o=q("el-alert");return x(),L("div",D,[d(e).table.remark?(x(),P(o,{key:0,class:"ba-table-alert",title:d(e).table.remark,type:"info","show-icon":""},null,8,["title"])):G("",!0),u(g,{buttons:["refresh","add","edit","delete","comSearch","quickSearch","columnDisplay"],"quick-search-placeholder":d(i)("Quick search placeholder",{fields:d(i)("routine.dataexport.quick Search Fields")})},null,8,["quick-search-placeholder"]),u(y,{ref_key:"tableRef",ref:_},null,512),u(N,{ref_key:"formRef",ref:f},null,512)])}}});export{W as default};
