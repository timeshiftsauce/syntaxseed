import{y as _,u as g,c as s,f as S,j as i,S as b,r as I}from"./index-C3V9u2Ed.js";import{a as N,H as p}from"./vue-DdIC1N8d.js";import{u}from"./index-BASh_3MO.js";import{u as D,t as x}from"./terminal-Dkg7p0iR.js";const e=N({loading:{buy:!1,table:!0,common:!1,install:!1,goodsInfo:!1},dialog:{buy:!1,pay:!1,common:!1,goodsInfo:!1,baAccount:!1},table:{remark:"",modules:[],modulesEbak:[],category:[],onlyLocal:!1,indexLoaded:!1,params:{quickSearch:"",activeTab:"all"}},payInfo:{},goodsInfo:{},buy:{info:{},renew:!1,agreement:!0},common:{uid:"",moduleState:0,quickClose:!1,type:"loading",dialogTitle:"",fileConflict:[],dependConflict:[],loadingTitle:"init",loadingComponentKey:_(),waitInstallDepend:[],dependInstallState:"none",disableConflictFile:[],disableDependConflict:[],disableParams:{},payType:"wx"},sysVersion:"",installedModule:[],installedModuleUids:[]}),m="/admin/module/",y="/api/v6.store/";function v(a={}){return s({url:m+"index",method:"get",params:a})}function M(a={}){const o=g();return s({url:o.apiUrl+y+"modules",method:"get",params:a})}function U(a){const o=u(),t=g();return s({url:t.apiUrl+y+"info",method:"get",params:a},{anotherToken:o.getToken("auth")})}function P(a={}){const o=u(),t=g();return s({url:t.apiUrl+y+"order",method:"post",params:a},{anotherToken:o.getToken("auth")})}function O(a,o){const t=u(),n=g();return s({url:n.apiUrl+y+"pay",method:"post",params:{order_id:a,pay_type:o}},{anotherToken:t.getToken("auth"),showSuccessMessage:!0})}function F(a){const o=u(),t=g();return s({url:t.apiUrl+"/api/pay/check",method:"get",params:{sn:a}},{anotherToken:o.getToken("auth"),showCodeMessage:!1})}function R(a){return s({url:m+"state",method:"get",params:{uid:a}})}function W(a,o,t={}){const n=u();return s({url:m+"install",method:"post",params:{uid:a,orderId:o,token:n.getToken("auth")},data:{extend:t},timeout:3e3*10},{showCodeMessage:!1})}function K(a,o,t={}){const n=u();return s({url:m+"update",method:"POST",params:{uid:a,orderId:o,token:n.getToken("auth")},data:{extend:t},timeout:3e3*10})}function X(a){return s({url:m+"uninstall",method:"post",params:{uid:a}},{showSuccessMessage:!0})}function k(a){return s({url:m+"changeState",method:"post",data:a},{showCodeMessage:!1})}function Z(a){return s({url:m+"dependentInstallComplete",method:"post",params:{uid:a}})}function J(a){const o=u();return s({url:m+"upload",method:"post",params:{file:a,token:o.getToken("auth")}})}var d=(a=>(a[a.UNINSTALLED=0]="UNINSTALLED",a[a.INSTALLED=1]="INSTALLED",a[a.WAIT_INSTALL=2]="WAIT_INSTALL",a[a.CONFLICT_PENDING=3]="CONFLICT_PENDING",a[a.DEPENDENT_WAIT_INSTALL=4]="DEPENDENT_WAIT_INSTALL",a[a.DIRECTORY_OCCUPIED=5]="DIRECTORY_OCCUPIED",a[a.DISABLE=6]="DISABLE",a))(d||{});const B=()=>{e.loading.table=!0,e.table.indexLoaded?E():V().then(()=>{E()})},r=()=>{e.table.indexLoaded=!1;for(const a in e.table.modulesEbak)e.table.modulesEbak[a]=void 0;B()},V=()=>v().then(a=>{e.table.indexLoaded=!0,e.sysVersion=a.data.sysVersion,e.installedModule=a.data.installed;const o=[];if(a.data.installed){for(const t in a.data.installed)o.push(a.data.installed[t].uid);e.installedModuleUids=o}}),E=()=>{if(typeof e.table.modulesEbak[e.table.params.activeTab]<"u"){e.table.modules[e.table.params.activeTab]=w(e.table.modulesEbak[e.table.params.activeTab]),e.loading.table=!1;return}const a={};for(const n in e.table.params)e.table.params[n]!=""&&(a[n]=e.table.params[n]);const o=[],t=[];e.installedModule.forEach(n=>{t.push({uid:n.uid,version:n.version})}),a.installed=t,a.sysVersion=e.sysVersion,M(a).then(n=>{a.activeTab=="all"&&(n.data.rows.forEach(l=>{o.push(l.uid)}),e.installedModule.forEach(l=>{o.indexOf(l.uid)===-1&&(e.table.params.quickSearch?l.title.includes(e.table.params.quickSearch)&&n.data.rows.push(l):n.data.rows.push(l))})),e.table.remark=n.data.remark,e.table.modulesEbak[a.activeTab]=n.data.rows.map(l=>{const c=e.installedModuleUids.indexOf(l.uid);return c!==-1?(l.state=e.installedModule[c].state,l.version=e.installedModule[c].version,l.website=e.installedModule[c].website,l.stateTag=z(l.state)):l.state=0,l.new_version&&l.tags&&l.tags.push({name:i.global.t("module.New version"),type:"danger"}),l}),e.table.modules[a.activeTab]=w(e.table.modulesEbak[a.activeTab]),e.table.category=n.data.category}).finally(()=>{e.loading.table=!1})},L=a=>{e.dialog.goodsInfo=!0,e.loading.goodsInfo=!0;const o=e.installedModule.find(t=>t.uid==a);U({uid:a,localVersion:o==null?void 0:o.version,sysVersion:e.sysVersion}).then(t=>{o?(t.data.info.type=="local"?(t.data.info=o,t.data.info.images=[S("/static/images/local-module-logo.png")],t.data.info.type="local"):(t.data.info.type="online",t.data.info.state=o.state,t.data.info.version=o.version),t.data.info.enable=o.state!==d.DISABLE):(t.data.info.state=0,t.data.info.type="online"),e.goodsInfo=t.data.info}).catch(t=>{h(t)&&(e.dialog.goodsInfo=!1)}).finally(()=>{e.loading.goodsInfo=!1})},Q=(a=!1)=>{e.dialog.buy=!0,e.loading.buy=!0,P({goods_id:e.goodsInfo.id}).then(o=>{e.loading.buy=!1,e.buy.renew=a,e.buy.info=o.data.info}).catch(o=>{e.dialog.buy=!1,e.loading.buy=!1,h(o)})},$=a=>{e.common.payType=a,e.loading.common=!0,O(e.buy.info.id,a).then(o=>{if(e.dialog.buy=!1,e.dialog.goodsInfo=!1,a=="wx"||a=="zfb"){e.dialog.pay=!0,e.payInfo=o.data;const t=setInterval(()=>{F(e.payInfo.info.sn).then(()=>{e.payInfo.pay.status="success",clearInterval(t),e.buy.renew?L(o.data.info.uid):C(o.data.info.uid,o.data.info.id),e.dialog.pay=!1}).catch(()=>{})},3e3)}else e.buy.renew?L(o.data.info.uid):C(o.data.info.uid,o.data.info.id)}).catch(o=>{h(o)}).finally(()=>{e.loading.common=!1})},T=a=>{e.common.type="loading",e.common.loadingTitle=a,e.common.loadingComponentKey=_()},C=(a,o)=>{e.dialog.common=!0,T("init"),e.common.dialogTitle=i.global.t("module.Install"),R(a).then(t=>{t.data.state===d.INSTALLED||t.data.state===d.DISABLE||t.data.state===d.DIRECTORY_OCCUPIED?(p({type:"error",message:t.data.state===d.INSTALLED||t.data.state===d.DISABLE?i.global.t("module.Installation cancelled because module already exists!"):i.global.t("module.Installation cancelled because the directory required by the module is occupied!")}),e.dialog.common=!1):(T(t.data.state===d.UNINSTALLED?"download":"install"),A(a,o),e.dialog.baAccount=!1,e.dialog.buy=!1,e.dialog.goodsInfo=!1)})},A=(a,o,t={})=>{W(a,o,t).then(()=>{e.common.dialogTitle=i.global.t("module.Installation complete"),e.common.moduleState=d.INSTALLED,e.common.type="done",r()}).catch(n=>{if(!h(n))if(n.code==-1)e.common.uid=n.data.uid,e.common.type="InstallConflict",e.common.dialogTitle=i.global.t("module.A conflict is found Please handle it manually"),e.common.fileConflict=n.data.fileConflict,e.common.dependConflict=n.data.dependConflict;else if(n.code==-2){e.common.type="done",e.common.uid=n.data.uid,e.common.dialogTitle=i.global.t("module.Wait for dependent installation"),e.common.moduleState=d.DEPENDENT_WAIT_INSTALL,e.common.waitInstallDepend=n.data.wait_install,e.common.dependInstallState="executing";const l=D();n.data.wait_install.includes("npm_dependent_wait_install")&&l.addTaskPM("web-install",!0,"module-install:"+n.data.uid,c=>{f(c,"npm_dependent_wait_install")}),n.data.wait_install.includes("nuxt_npm_dependent_wait_install")&&l.addTaskPM("nuxt-install",!0,"module-install:"+n.data.uid,c=>{f(c,"nuxt_npm_dependent_wait_install")}),n.data.wait_install.includes("composer_dependent_wait_install")&&l.addTask("composer.update",!0,"module-install:"+n.data.uid,c=>{f(c,"composer_dependent_wait_install")})}else n.code==0&&(p({type:"error",message:n.msg,zIndex:b}),e.dialog.common=!1,r())}).finally(()=>{e.loading.common=!1})},f=(a,o)=>{a==x.Success?(e.common.waitInstallDepend=e.common.waitInstallDepend.filter(t=>t!=o),e.common.waitInstallDepend.length==0&&(e.common.dependInstallState="success",I.currentRoute.value.name==="moduleStore/moduleStore"&&r())):(D().toggle(!0),e.common.dependInstallState="fail",I.currentRoute.value.name==="moduleStore/moduleStore"&&r()),I.currentRoute.value.name},ee=(a=!1)=>{if(e.loading.common=!0,a){const o={};for(const t in e.common.disableDependConflict)e.common.disableDependConflict[t].solution=="delete"&&(typeof o[e.common.disableDependConflict[t].env]>"u"&&(o[e.common.disableDependConflict[t].env]=[]),o[e.common.disableDependConflict[t].env].push(e.common.disableDependConflict[t].depend));e.common.disableParams.confirmConflict=1,e.common.disableParams.dependConflictSolution=o}k(e.common.disableParams).then(()=>{p({type:"success",message:i.global.t("module.The operation succeeds Please clear the system cache and refresh the browser ~"),zIndex:b}),e.dialog.common=!1,r()}).catch(o=>{if(o.code==-1){if(e.dialog.common=!0,e.common.dialogTitle=i.global.t("module.Deal with conflict"),e.common.type="disableConfirmConflict",e.common.disableDependConflict=o.data.dependConflict,o.data.conflictFile&&o.data.conflictFile.length){const t=[];for(const n in o.data.conflictFile)t.push({file:o.data.conflictFile[n]});e.common.disableConflictFile=t}}else if(o.code==-2){e.dialog.common=!0;const t={commands:o.data.wait_install};e.common.uid=e.goodsInfo.uid,q(t)}else o.code==-3?C(e.goodsInfo.uid,e.goodsInfo.purchased):(p({type:"error",message:o.msg,zIndex:b}),r())}).finally(()=>{e.loading.common=!1})},ae=a=>{e.loading.common=!0,k({uid:a,state:1}).then(()=>{e.dialog.common=!0,T("init"),e.common.dialogTitle=i.global.t("Enable"),A(a,0),e.dialog.goodsInfo=!1}).catch(o=>{p({type:"error",message:o.msg,zIndex:b})})},h=a=>{const o=u();return a.code==301||a.code==408?(o.removeToken(),e.dialog.baAccount=!0,!0):!1},w=a=>e.table.onlyLocal?a.filter(o=>o.state>d.UNINSTALLED):a,q=a=>{{e.dialog.common=!0,e.common.type="done",e.common.dialogTitle=i.global.t("module.Wait for dependent installation"),e.common.moduleState=d.DISABLE,e.common.dependInstallState="executing";const o=D();a.commands.forEach(t=>{e.common.waitInstallDepend.push(t.type),t.pm?(t.command=="web-install",o.addTaskPM(t.command,!0,"",n=>{f(n,t.type),t.command=="web-install"})):o.addTask(t.command,!0,"",n=>{f(n,t.type)})})}},oe=a=>a.nickname+"（"+(a.email||a.mobile||"ID:"+a.id)+"）",te=(a,o)=>typeof a>"u"||typeof o>"u"?"-":o==0?parseInt(a.toString())+i.global.t("Integral"):"￥"+a,z=a=>{switch(a){case d.INSTALLED:return{type:"",text:i.global.t("module.installed")};case d.WAIT_INSTALL:return{type:"success",text:i.global.t("module.Wait for installation")};case d.CONFLICT_PENDING:return{type:"danger",text:i.global.t("module.Conflict pending")};case d.DEPENDENT_WAIT_INSTALL:return{type:"warning",text:i.global.t("module.Dependency to be installed")};case d.DISABLE:return{type:"warning",text:i.global.t("Disable")};default:return{type:"info",text:i.global.t("Unknown")}}};export{oe as a,C as b,te as c,Z as d,A as e,r as f,ee as g,Q as h,L as i,ae as j,R as k,K as l,d as m,h as n,$ as o,X as p,B as q,e as s,J as u};
