import{e as ee,p as le,al as te,a as A,m as x,Y as w,h as V,o as u,l as o,O as n,Z as T,N as c,T as y,s as l,a6 as oe,X as F,W as k,k as v,U as S,V as h,j as ae,n as ne}from"./vue-5rLikWvG.js";import{x as de,y as O,_ as re}from"./index-CE4S5SW2.js";import{F as b}from"./index-BqsO7Sfb.js";import{b as U}from"./validate-BRwK53XH.js";import{d as B}from"./dataexport-Nnqu7Kbs.js";import"./index-B3Ea6OYo.js";import"./index-CZNKlKfc.js";const ie={class:"title"},me={key:0},ue={key:0},se={key:0},fe={key:0},pe=["onClick"],ce=["onClick"],be=ee({__name:"popupForm",setup(_e,{expose:D}){const N=le(),e=te("baTable"),{t:m}=de.useI18n(),K=A({tab:"base"}),E=(p,a,i)=>{p=="del"?e.form.items.where.splice(a,1):p=="add"&&e.form.items.where.push({...i,value:"",operator:"eq"})},I=p=>{e.form.extend.fieldLoading=!0,B(p).then(a=>{e.form.extend.fieldSelect=a.data.fields;const i=[],r=[];for(const f in a.data.fields)i.push(f),r[f]=a.data.fields[f].name+(a.data.fields[f].title?" - "+a.data.fields[f].title:"");e.form.extend.fieldSelectOpt=r,e.form.extend.fieldSelectKey=O(),e.form.items.fields=i,typeof e.form.extend.onTableChangeCallback=="function"&&(e.form.extend.onTableChangeCallback(),e.form.extend.onTableChangeCallback=null)}).finally(()=>{e.form.extend.fieldLoading=!1})},P=(p,a)=>{e.form.extend.fieldLoading=!0,B(p).then(i=>{typeof e.form.extend.joinTableFieldSelect>"u"&&(e.form.extend.joinTableFieldSelect=[],e.form.extend.joinTableFieldSelectOpt=[],e.form.extend.joinTableFieldSelectKey=[]),e.form.extend.joinTableFieldSelect[a]=i.data.fields;const r=[];for(const f in i.data.fields)r[f]=i.data.fields[f].name+(i.data.fields[f].title?" - "+i.data.fields[f].title:"");e.form.extend.joinTableFieldSelectOpt[a]=r,e.form.extend.joinTableFieldSelectKey[a]=O(),e.form.items.onJoinTableChangeCallback&&e.form.items.onJoinTableChangeCallback[a]&&typeof e.form.items.onJoinTableChangeCallback[a]=="function"&&(e.form.items.onJoinTableChangeCallback[a](),e.form.items.onJoinTableChangeCallback[a]=null)}).finally(()=>{e.form.extend.fieldLoading=!1})},J=p=>{if(p=="where"){e.form.extend.fieldLoading=!0;const a=[];for(const i in e.form.extend.fieldSelectOpt)a[e.form.items.main_table+"."+i]=e.form.items.main_table+"."+e.form.extend.fieldSelectOpt[i];for(const i in e.form.items.joinTable){const r=e.form.items.joinTableAsName[i]?e.form.items.joinTableAsName[i]:e.form.items.joinTable[i];for(const f in e.form.extend.joinTableFieldSelectOpt[i])a[r+"."+f]=r+"."+e.form.extend.joinTableFieldSelectOpt[i][f]}e.form.extend.allTableField=a,e.form.extend.fieldLoading=!1,e.form.extend.allTableFieldKey=O()}},M=()=>{e.form.items.where.push({value:"",operator:"eq",field:e.form.items.where_field}),e.form.items.where_field="",ne(()=>{const p=document.querySelectorAll(".where-field-input");if(p){const a=p[p.length-1].querySelector(".el-input__inner");a&&a.focus()}})},R=()=>{const p=[];for(const a in e.form.items.order_field){let i="DESC";for(const r in e.form.items.order)if(e.form.items.order[r].field==e.form.items.order_field[a]){i=e.form.items.order[r].value;break}p[a]={value:i,field:e.form.items.order_field[a]}}e.form.items.order=p},$=A({name:[U({name:"required",title:m("routine.dataexport.name")})],main_table:[U({name:"required",message:m("Please select field",{field:m("routine.dataexport.main_table")})})],concurrent_create_xls:[U({name:"required",title:m("routine.dataexport.concurrent_create_xls")})],memory_limit:[U({name:"required",title:m("routine.dataexport.memory_limit")}),{validator:(p,a,i)=>{let r=(e.form.items.fields&&e.form.items.fields.length)??0;for(const s in e.form.items.joinTableFields)r+=e.form.items.joinTableFields[s].length;if(r<=0)return i(new Error("请先在基础配置中选择导出字段"));const f=r*e.form.items.xls_max_number/1024;return f>=e.form.items.memory_limit?i(new Error("预计需要更多内存 > "+(f+50).toFixed(0)+"MB")):i()},trigger:"blur"}],fields:[U({name:"required",message:m("Please select field",{field:"导出字段"})})]});return D({onTableChange:I,onJoinTableChange:P}),(p,a)=>{const i=x("el-tooltip"),r=x("el-col"),f=x("el-input"),s=x("el-option"),j=x("el-select"),C=x("el-row"),L=x("el-tab-pane"),W=x("el-form-item"),z=x("el-tabs"),G=x("el-form"),H=x("el-scrollbar"),q=x("el-button"),X=x("el-dialog"),Y=w("drag"),Z=w("zoom"),g=w("loading"),Q=w("blur");return u(),V("div",null,[o(X,{class:"ba-operate-dialog","close-on-click-modal":!1,"model-value":!!l(e).form.operate,onClose:l(e).toggleForm,"destroy-on-close":!0},{header:n(()=>[T((u(),V("div",ie,[h(S(l(e).form.operate?l(m)(l(e).form.operate):""),1)])),[[Y,[".ba-operate-dialog",".el-dialog__header"]],[Z,".ba-operate-dialog"]])]),footer:n(()=>[v("div",{style:ae("width: calc(100% - "+l(e).form.labelWidth/1.8+"px)")},[o(q,{onClick:a[12]||(a[12]=t=>l(e).toggleForm(""))},{default:n(()=>[h(S(l(m)("Cancel")),1)]),_:1}),T((u(),c(q,{loading:l(e).form.submitLoading,onClick:a[13]||(a[13]=t=>l(e).onSubmit(N.value)),type:"primary"},{default:n(()=>[h(S(l(e).form.operateIds&&l(e).form.operateIds.length>1?l(m)("Save and edit next item"):l(m)("Save")),1)]),_:1},8,["loading"])),[[Q]])],4)]),default:n(()=>[T((u(),c(H,{class:"ba-table-form-scrollbar"},{default:n(()=>[l(e).form.loading?y("",!0):(u(),c(G,{key:0,ref_key:"formRef",ref:N,onKeyup:a[11]||(a[11]=oe(t=>l(e).onSubmit(N.value),["enter"])),model:l(e).form.items,"label-position":"top",rules:$},{default:n(()=>[o(z,{class:"config-tabs",onTabChange:J,modelValue:K.tab,"onUpdate:modelValue":a[10]||(a[10]=t=>K.tab=t)},{default:n(()=>[o(L,{label:"基础配置",name:"base"},{default:n(()=>[o(b,{label:l(m)("routine.dataexport.name"),type:"string",modelValue:l(e).form.items.name,"onUpdate:modelValue":a[0]||(a[0]=t=>l(e).form.items.name=t),prop:"name","input-attr":{placeholder:l(m)("Please input field",{field:l(m)("routine.dataexport.name")})}},null,8,["label","modelValue","input-attr"]),T(o(b,{label:l(m)("routine.dataexport.main_table"),type:"select",modelValue:l(e).form.items.main_table,"onUpdate:modelValue":a[1]||(a[1]=t=>l(e).form.items.main_table=t),prop:"main_table",data:{content:l(e).form.extend.tables},"input-attr":{placeholder:l(m)("Please select field",{field:l(m)("routine.dataexport.main_table")}),onChange:I}},null,8,["label","modelValue","data","input-attr"]),[[g,l(e).form.extend.fieldLoading]]),l(e).form.extend.fieldSelectOpt?T((u(),c(b,{label:"导出字段",type:"selects",modelValue:l(e).form.items.fields,"onUpdate:modelValue":a[2]||(a[2]=t=>l(e).form.items.fields=t),key:l(e).form.extend.fieldSelectKey,prop:"fields",placeholder:"请先选择导出数据源表，随后在此选择导出字段",data:{content:l(e).form.extend.fieldSelectOpt}},null,8,["modelValue","data"])),[[g,l(e).form.extend.fieldLoading]]):y("",!0),(u(!0),V(F,null,k(l(e).form.items.fields,t=>(u(),c(C,{key:t,class:"field-row"},{default:n(()=>[o(r,{span:4,class:"field-title"},{default:n(()=>[o(i,{placement:"top",content:l(e).form.extend.fieldSelect[t].name},{default:n(()=>[v("div",null,S(l(e).form.extend.fieldSelect[t].name)+":",1)]),_:2},1032,["content"])]),_:2},1024),o(r,{span:4},{default:n(()=>[o(f,{type:"text",placeholder:"字段标题",modelValue:l(e).form.extend.fieldSelect[t].title,"onUpdate:modelValue":d=>l(e).form.extend.fieldSelect[t].title=d,class:"field-title-input"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),o(r,{span:3,class:"field-title-input-title"},{default:n(()=>a[14]||(a[14]=[h("数据识别:")])),_:1}),o(r,{span:4},{default:n(()=>[o(j,{modelValue:l(e).form.extend.fieldSelect[t].discern,"onUpdate:modelValue":d=>l(e).form.extend.fieldSelect[t].discern=d},{default:n(()=>[o(s,{label:"文本",value:"text"}),o(s,{label:"数字",value:"int"}),o(s,{label:"时间日期",value:"time"}),o(s,{label:"值替换",value:"valuation"}),o(s,{label:"省份城市",value:"city"})]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:2},1024),o(r,{span:3,class:"field-title-input-title"},{default:n(()=>[l(e).form.extend.fieldSelect[t].discern=="valuation"?(u(),V("div",me,"替换方案:")):y("",!0)]),_:2},1024),o(r,{span:6},{default:n(()=>[l(e).form.extend.fieldSelect[t].discern=="valuation"?(u(),V("div",ue,[o(f,{type:"text",placeholder:"值替换方案",modelValue:l(e).form.extend.fieldSelect[t].comment,"onUpdate:modelValue":d=>l(e).form.extend.fieldSelect[t].comment=d,class:"field-title-input"},null,8,["modelValue","onUpdate:modelValue"])])):y("",!0)]),_:2},1024)]),_:2},1024))),128))]),_:1}),o(L,{label:"关联表配置",name:"join"},{default:n(()=>[o(b,{label:"关联表数量",type:"number",modelValue:l(e).form.items.joinTableNumber,"onUpdate:modelValue":a[3]||(a[3]=t=>l(e).form.items.joinTableNumber=t),modelModifiers:{number:!0}},null,8,["modelValue"]),(u(!0),V(F,null,k(l(e).form.items.joinTableNumber,t=>(u(),V("div",{key:t,class:"join-table-item"},[a[16]||(a[16]=v("div",{class:"form-hr"},null,-1)),o(W,{label:"关联表"+t},{default:n(()=>[T((u(),c(j,{class:"w100",placeholder:l(m)("Please select field",{field:"关联表"+t}),modelValue:l(e).form.items.joinTable[t-1],"onUpdate:modelValue":d=>l(e).form.items.joinTable[t-1]=d,onChange:d=>P(d,t-1)},{default:n(()=>[(u(!0),V(F,null,k(l(e).form.extend.tables,(d,_)=>(u(),c(s,{label:d,value:_,key:_},null,8,["label","value"]))),128))]),_:2},1032,["placeholder","modelValue","onUpdate:modelValue","onChange"])),[[g,l(e).form.extend.fieldLoading]])]),_:2},1032,["label"]),o(b,{type:"string",placeholder:"非必填，设置别名后则源表可与关联表相同",label:"关联表别名",modelValue:l(e).form.items.joinTableAsName[t-1],"onUpdate:modelValue":d=>l(e).form.items.joinTableAsName[t-1]=d},null,8,["modelValue","onUpdate:modelValue"]),l(e).form.extend.fieldSelectOpt?T((u(),c(b,{label:"关联外键",type:"select",modelValue:l(e).form.items.joinTableFk[t-1],"onUpdate:modelValue":d=>l(e).form.items.joinTableFk[t-1]=d,key:l(e).form.extend.fieldSelectKey+"fk",placeholder:"请先选择源表，随后在此关联外键",data:{content:l(e).form.extend.fieldSelectOpt}},null,8,["modelValue","onUpdate:modelValue","data"])),[[g,l(e).form.extend.fieldLoading]]):y("",!0),l(e).form.extend.joinTableFieldSelectOpt&&l(e).form.extend.joinTableFieldSelectOpt[t-1]?T((u(),c(b,{label:"关联主键",type:"select",modelValue:l(e).form.items.joinTablePk[t-1],"onUpdate:modelValue":d=>l(e).form.items.joinTablePk[t-1]=d,key:l(e).form.extend.joinTableFieldSelectKey[t-1]+"pk",placeholder:"请先选择关联表"+t+"，随后在此选择关联主键",data:{content:l(e).form.extend.joinTableFieldSelectOpt[t-1]}},null,8,["modelValue","onUpdate:modelValue","placeholder","data"])),[[g,l(e).form.extend.fieldLoading]]):y("",!0),o(b,{label:"关联类型",type:"select",modelValue:l(e).form.items.joinTableType[t-1],"onUpdate:modelValue":d=>l(e).form.items.joinTableType[t-1]=d,placeholder:"请选择关联类型",data:{content:{INNER:"INNER - 至少一个匹配",LEFT:"LEFT - 从左表返回所有行",RIGHT:"RIGHT - 从右表返回所有行",FULL:"FULL - 返回所有行"}}},null,8,["modelValue","onUpdate:modelValue"]),l(e).form.extend.joinTableFieldSelectOpt&&l(e).form.extend.joinTableFieldSelectOpt[t-1]?T((u(),c(b,{label:"导出字段",type:"selects",modelValue:l(e).form.items.joinTableFields[t-1],"onUpdate:modelValue":d=>l(e).form.items.joinTableFields[t-1]=d,key:l(e).form.extend.joinTableFieldSelectKey[t-1],placeholder:"请先选择关联表"+t+"，随后在此选择该表的导出字段",data:{content:l(e).form.extend.joinTableFieldSelectOpt[t-1]}},null,8,["modelValue","onUpdate:modelValue","placeholder","data"])),[[g,l(e).form.extend.fieldLoading]]):y("",!0),l(e).form.items.joinTableFields&&l(e).form.items.joinTableFields[t-1]?(u(!0),V(F,{key:3},k(l(e).form.items.joinTableFields[t-1],d=>(u(),c(C,{key:d,class:"field-row"},{default:n(()=>[o(r,{span:4,class:"field-title"},{default:n(()=>[o(i,{placement:"top",content:l(e).form.extend.joinTableFieldSelect[t-1][d].name},{default:n(()=>[v("div",null,S(l(e).form.extend.joinTableFieldSelect[t-1][d].name)+":",1)]),_:2},1032,["content"])]),_:2},1024),o(r,{span:4},{default:n(()=>[o(f,{type:"text",placeholder:"字段标题",modelValue:l(e).form.extend.joinTableFieldSelect[t-1][d].title,"onUpdate:modelValue":_=>l(e).form.extend.joinTableFieldSelect[t-1][d].title=_,class:"field-title-input"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),o(r,{span:3,class:"field-title-input-title"},{default:n(()=>a[15]||(a[15]=[h("数据识别:")])),_:1}),o(r,{span:4},{default:n(()=>[o(j,{modelValue:l(e).form.extend.joinTableFieldSelect[t-1][d].discern,"onUpdate:modelValue":_=>l(e).form.extend.joinTableFieldSelect[t-1][d].discern=_},{default:n(()=>[o(s,{label:"文本",value:"text"}),o(s,{label:"数字",value:"int"}),o(s,{label:"时间日期",value:"time"}),o(s,{label:"值替换",value:"valuation"}),o(s,{label:"省份城市",value:"city"})]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:2},1024),o(r,{span:3,class:"field-title-input-title"},{default:n(()=>[l(e).form.extend.joinTableFieldSelect[t-1][d].discern=="valuation"?(u(),V("div",se," 替换方案: ")):y("",!0)]),_:2},1024),o(r,{span:6},{default:n(()=>[l(e).form.extend.joinTableFieldSelect[t-1][d].discern=="valuation"?(u(),V("div",fe,[o(f,{type:"text",placeholder:"值替换方案",modelValue:l(e).form.extend.joinTableFieldSelect[t-1][d].comment,"onUpdate:modelValue":_=>l(e).form.extend.joinTableFieldSelect[t-1][d].comment=_,class:"field-title-input"},null,8,["modelValue","onUpdate:modelValue"])])):y("",!0)]),_:2},1024)]),_:2},1024))),128)):y("",!0)]))),128))]),_:1}),o(L,{label:"数据筛选配置",name:"where"},{default:n(()=>[l(e).form.extend.allTableField?T((u(),c(b,{label:"添加筛选字段",type:"select",modelValue:l(e).form.items.where_field,"onUpdate:modelValue":a[4]||(a[4]=t=>l(e).form.items.where_field=t),placeholder:"请先选择源表和关联表，随后在此选择数据筛选字段",data:{content:l(e).form.extend.allTableField},key:l(e).form.extend.allTableFieldKey,"input-attr":{onChange:M}},null,8,["modelValue","data","input-attr"])),[[g,l(e).form.extend.fieldLoading]]):y("",!0),(u(!0),V(F,null,k(l(e).form.items.where,(t,d)=>(u(),c(C,{key:t,gutter:10,class:"field-row"},{default:n(()=>[o(r,{span:5,class:"field-title"},{default:n(()=>[o(i,{placement:"top",content:t.field},{default:n(()=>[v("div",null,S(t.field)+":",1)]),_:2},1032,["content"])]),_:2},1024),o(r,{span:6},{default:n(()=>[o(j,{modelValue:t.operator,"onUpdate:modelValue":_=>t.operator=_},{default:n(()=>[o(s,{label:"等于",value:"eq"}),o(s,{label:"不等于",value:"ne"}),o(s,{label:"大于",value:"gt"}),o(s,{label:"大于等于",value:"egt"}),o(s,{label:"小于",value:"lt"}),o(s,{label:"小于等于",value:"elt"}),o(s,{label:"LIKE",value:"LIKE"}),o(s,{label:"NOT LIKE",value:"NOT LIKE"}),o(s,{label:"IN",value:"IN"}),o(s,{label:"NOT IN",value:"NOT IN"})]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:2},1024),o(r,{span:10},{default:n(()=>[v("div",null,[o(f,{type:"text",placeholder:"筛选值",modelValue:t.value,"onUpdate:modelValue":_=>t.value=_,class:"field-title-input where-field-input"},null,8,["modelValue","onUpdate:modelValue"])])]),_:2},1024),o(r,{span:3},{default:n(()=>[v("span",{class:"where-field-btn",onClick:_=>E("add",d,t)},"[ + ]",8,pe),v("span",{class:"where-field-btn del",onClick:_=>E("del",d,t)},"[ - ]",8,ce)]),_:2},1024)]),_:2},1024))),128)),a[17]||(a[17]=v("div",{class:"form-hr"},null,-1)),l(e).form.extend.allTableField?T((u(),c(b,{label:"排序字段",type:"selects",modelValue:l(e).form.items.order_field,"onUpdate:modelValue":a[5]||(a[5]=t=>l(e).form.items.order_field=t),placeholder:"请先选择源表和关联表，随后在此选择数据排序字段",data:{content:l(e).form.extend.allTableField},key:l(e).form.extend.allTableFieldKey+"order","input-attr":{onChange:R}},null,8,["modelValue","data","input-attr"])),[[g,l(e).form.extend.fieldLoading]]):y("",!0),(u(!0),V(F,null,k(l(e).form.items.order,t=>(u(),c(C,{key:t,gutter:10,class:"field-row"},{default:n(()=>[o(r,{span:6,class:"field-title"},{default:n(()=>[o(i,{placement:"top",content:t.field},{default:n(()=>[v("div",null,S(t.field)+":",1)]),_:2},1032,["content"])]),_:2},1024),o(r,{span:6},{default:n(()=>[o(j,{modelValue:t.value,"onUpdate:modelValue":d=>t.value=d},{default:n(()=>[o(s,{label:"倒序(从大到小)",value:"DESC"}),o(s,{label:"正序(从小到大)",value:"ASC"})]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024))),128))]),_:1}),o(L,{label:"其他配置",name:"other"},{default:n(()=>[o(b,{label:l(m)("routine.dataexport.xls_max_number"),type:"number",prop:"xls_max_number",modelValue:l(e).form.items.xls_max_number,"onUpdate:modelValue":a[6]||(a[6]=t=>l(e).form.items.xls_max_number=t),modelModifiers:{number:!0},"input-attr":{step:1,placeholder:l(m)("Please input field",{field:l(m)("routine.dataexport.xls_max_number")})}},null,8,["label","modelValue","input-attr"]),o(b,{label:l(m)("routine.dataexport.concurrent_create_xls"),type:"number",prop:"concurrent_create_xls",modelValue:l(e).form.items.concurrent_create_xls,"onUpdate:modelValue":a[7]||(a[7]=t=>l(e).form.items.concurrent_create_xls=t),modelModifiers:{number:!0},"input-attr":{step:1,placeholder:l(m)("Please input field",{field:l(m)("routine.dataexport.concurrent_create_xls")})}},null,8,["label","modelValue","input-attr"]),o(b,{label:l(m)("routine.dataexport.memory_limit"),type:"number",prop:"memory_limit",modelValue:l(e).form.items.memory_limit,"onUpdate:modelValue":a[8]||(a[8]=t=>l(e).form.items.memory_limit=t),modelModifiers:{number:!0},"input-attr":{step:1,placeholder:l(m)("Please input field",{field:l(m)("routine.dataexport.memory_limit")})}},null,8,["label","modelValue","input-attr"]),o(b,{label:l(m)("routine.dataexport.export_number"),type:"number",prop:"export_number",modelValue:l(e).form.items.export_number,"onUpdate:modelValue":a[9]||(a[9]=t=>l(e).form.items.export_number=t),modelModifiers:{number:!0},"input-attr":{step:1,placeholder:l(m)("Please input field",{field:l(m)("routine.dataexport.export_number")})+"，留空或输入 0 则导出全部"}},null,8,["label","modelValue","input-attr"])]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["model","rules"]))]),_:1})),[[g,l(e).form.loading]])]),_:1},8,["model-value","onClose"])])}}}),Fe=re(be,[["__scopeId","data-v-2911dede"]]);export{Fe as default};
