import{e as I,M as q,a as v,m as l,h as N,o as u,l as n,N as k,T as S,O as o,k as f,U as c,V as i}from"./vue-5rLikWvG.js";import{c as V,_ as B}from"./index-CE4S5SW2.js";import{e as P,f as Z,h as D}from"./dataexport-Nnqu7Kbs.js";const U={class:"default-main"},A={style:{display:"flex","align-items":"center"}},E=I({name:"routine/dataexport/taskControl",__name:"taskControl",setup(M){const g=q(),t=v({task:{},subTask:[],requestIdx:0}),p=()=>{let s=[];for(const e in t.subTask[t.requestIdx])b(t.subTask[t.requestIdx][e].id,1),s.push(V({url:Z(t.task.id,t.subTask[t.requestIdx][e].id),method:"get"}).then(r=>{b(r.data.subId,2),t.task.lastprogress+=t.task.subtask_progress}));s.length?Promise.all(s).then(()=>{s=[],t.requestIdx++,p()}):t.task.lastprogress=100},b=(s,e)=>{for(const r in t.task.subtask)if(t.task.subtask[r].id==s){t.task.subtask[r].status=e,t.task.subtask[r].status_text=m(e);break}};P(g.params.id).then(s=>{t.task=s.data.task,t.subTask=s.data.subtaskPage;for(const e in t.task.subtask)t.task.subtask[e].status_text=m(t.task.subtask[e].status);p()});const x=()=>{D(t.task.id).then(s=>{window.location.href=s.data.url})},w=[{color:"#909399",percentage:20},{color:"#a0cfff",percentage:40},{color:"#409eff",percentage:60},{color:"#95d475",percentage:80},{color:"#67c23a",percentage:100}],m=s=>{let e="";switch(s){case 0:e="准备好";break;case 1:e="进行中";break;case 2:e="完成";break;case 3:e="失败";break}return e};return(s,e)=>{const r=l("el-alert"),_=l("el-table-column"),d=l("el-tag"),y=l("el-table"),h=l("el-progress"),T=l("el-button"),C=l("el-result");return u(),N("div",U,[n(r,{title:"《"+(t.task.name??"")+"》正在执行中，请勿刷新浏览器或关闭标签页...",type:"error",closable:!1,effect:"dark",class:"mb20"},null,8,["title"]),n(y,{data:t.task.subtask,border:"",style:{width:"100%"}},{default:o(()=>[n(_,{prop:"id",label:"序号",align:"center",width:"60"}),n(_,{label:"任务标题"},{default:o(a=>[f("div",A,"第 "+c(a.row.min)+" 到 "+c(a.row.min+a.row.max)+" 行数据",1)]),_:1}),n(_,{prop:"status_text",align:"center",label:"状态",width:"100"},{default:o(a=>[f("div",null,[a.row.status==0?(u(),k(d,{key:0,type:"info"},{default:o(()=>[i(c(a.row.status_text),1)]),_:2},1024)):a.row.status==1?(u(),k(d,{key:1},{default:o(()=>[i(c(a.row.status_text),1)]),_:2},1024)):a.row.status==2?(u(),k(d,{key:2,type:"success"},{default:o(()=>[i(c(a.row.status_text),1)]),_:2},1024)):(u(),k(d,{key:3,type:"danger"},{default:o(()=>[i(c(a.row.status_text),1)]),_:2},1024))])]),_:1})]),_:1},8,["data"]),n(h,{class:"task-progress",color:w,"stroke-width":16,percentage:t.task.lastprogress,"text-inside":!0},null,8,["percentage"]),Number(t.task.lastprogress)>=100?(u(),k(C,{key:0,icon:"success",title:"数据已备好","sub-title":"点击下载导出的数据包文件"},{extra:o(()=>[n(T,{onClick:x,type:"primary"},{default:o(()=>e[0]||(e[0]=[i("下载ZIP")])),_:1})]),_:1})):S("",!0)])}}}),z=B(E,[["__scopeId","data-v-669b8e0a"]]);export{z as default};
