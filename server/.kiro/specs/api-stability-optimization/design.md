# 设计文档

## 概述

本设计文档旨在解决个人作品集和博客系统后端API在高并发情况下出现500错误的问题。通过优化数据库连接管理、增强错误处理机制、添加请求限流和改进资源管理，提升系统的稳定性和并发处理能力。

## 架构

### 当前架构问题分析

1. **数据库连接管理不当**
   - 缺少连接池配置，每个请求可能创建新连接
   - 没有连接超时和重试机制
   - 长时间运行可能导致连接泄漏

2. **错误处理机制简陋**
   - 统一返回500错误，无法区分具体问题
   - 缺少详细的错误日志记录
   - 没有针对不同错误类型的处理策略

3. **缺少并发控制**
   - 没有请求限流机制
   - 缺少资源使用监控
   - 高并发时容易导致系统过载

### 优化后架构设计

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   API Gateway   │───▶│  Rate Limiting   │───▶│  Route Handler  │
│  (Express App)  │    │   Middleware     │    │   (getData)     │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                                        │
                                                        ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│  Error Handler  │◀───│  Database Pool   │◀───│  Query Builder  │
│   Middleware    │    │   Management     │    │    (Knex.js)    │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │  MySQL Database │
                       │   (Connection   │
                       │      Pool)      │
                       └─────────────────┘
```

## 组件和接口

### 1. 数据库连接池管理器

**功能：** 管理MySQL连接池，确保连接的高效使用和自动回收

**配置参数：**

```javascript
{
  pool: {
    min: 2,           // 最小连接数
    max: 10,          // 最大连接数
    acquireTimeoutMillis: 30000,  // 获取连接超时时间
    createTimeoutMillis: 30000,   // 创建连接超时时间
    destroyTimeoutMillis: 5000,   // 销毁连接超时时间
    idleTimeoutMillis: 30000,     // 空闲连接超时时间
    reapIntervalMillis: 1000,     // 清理间隔时间
    createRetryIntervalMillis: 200, // 重试间隔时间
    propagateCreateError: false   // 是否传播创建错误
  }
}
```

### 2. 增强错误处理中间件

**功能：** 统一处理各种类型的错误，提供详细的错误信息和适当的HTTP状态码

**错误类型映射：**

- 数据库连接错误 → 503 Service Unavailable
- 查询超时错误 → 408 Request Timeout
- 参数验证错误 → 400 Bad Request
- 资源不存在错误 → 404 Not Found
- 系统过载错误 → 429 Too Many Requests
- 未知错误 → 500 Internal Server Error

### 3. 请求限流中间件

**功能：** 控制并发请求数量，防止系统过载

**限流策略：**

- 基于IP的请求频率限制
- 基于接口的并发数量限制
- 滑动窗口算法实现

### 4. 查询优化器

**功能：** 优化数据库查询，减少资源消耗

**优化策略：**

- 查询结果缓存（内存缓存）
- 批量查询优化
- 索引使用建议

## 数据模型

### 错误日志模型

```javascript
{
  timestamp: Date,      // 错误发生时间
  level: String,        // 错误级别 (ERROR, WARN, INFO)
  message: String,      // 错误消息
  stack: String,        // 错误堆栈
  request: {            // 请求信息
    method: String,
    url: String,
    headers: Object,
    body: Object,
    ip: String
  },
  response: {           // 响应信息
    statusCode: Number,
    headers: Object
  },
  database: {           // 数据库相关信息
    query: String,
    params: Array,
    executionTime: Number
  }
}
```

### 连接池状态模型

```javascript
{
  total: Number,        // 总连接数
  active: Number,       // 活跃连接数
  idle: Number,         // 空闲连接数
  pending: Number,      // 等待连接数
  acquireCount: Number, // 获取连接次数
  releaseCount: Number, // 释放连接次数
  timeouts: Number      // 超时次数
}
```

## 错误处理

### 1. 分层错误处理策略

**数据库层错误：**

- 连接失败：自动重试3次，间隔递增
- 查询超时：记录慢查询日志，返回408状态码
- 连接池耗尽：返回503状态码，建议稍后重试

**业务逻辑层错误：**

- 参数验证失败：返回400状态码和具体错误信息
- 资源不存在：返回404状态码
- 权限不足：返回403状态码

**系统层错误：**

- 内存不足：返回503状态码
- 文件系统错误：返回500状态码
- 网络错误：返回502状态码

### 2. 错误恢复机制

**自动重试：**

- 数据库连接失败时自动重试
- 使用指数退避算法控制重试间隔
- 最大重试次数限制

**降级处理：**

- 缓存数据返回（如果可用）
- 简化响应内容
- 临时禁用非关键功能

### 3. 错误监控和告警

**实时监控：**

- 错误率统计
- 响应时间监控
- 数据库连接池状态监控

**告警机制：**

- 错误率超过阈值时发送告警
- 数据库连接异常时发送告警
- 系统资源使用率过高时发送告警

## 测试策略

### 1. 单元测试

**数据库连接池测试：**

- 连接创建和销毁测试
- 连接池配置参数测试
- 连接泄漏检测测试

**错误处理测试：**

- 各种错误类型的处理测试
- 错误日志记录测试
- 错误恢复机制测试

### 2. 集成测试

**API接口测试：**

- 所有现有接口的功能测试
- 响应格式一致性测试
- 错误场景测试

**数据库交互测试：**

- 查询正确性测试
- 事务处理测试
- 并发访问测试

### 3. 性能测试

**并发测试：**

- 模拟高并发请求场景
- 测试系统在不同负载下的表现
- 验证限流机制的有效性

**压力测试：**

- 测试系统的最大承载能力
- 验证错误处理在极端情况下的表现
- 测试系统恢复能力

### 4. 稳定性测试

**长时间运行测试：**

- 24小时连续运行测试
- 内存泄漏检测
- 连接池稳定性测试

**故障恢复测试：**

- 数据库连接中断恢复测试
- 网络异常恢复测试
- 系统重启后的恢复测试
